{% extends "layout.html" %}
{% block content %}
  <div class="row mb-3">
    <div class="col-12 col-md-4">
      <div class="card text-white bg-success mb-3">
        <div class="card-body">
          <h6 class="card-title">Income</h6>
          <h4>{{ income | round(2) }}</h4>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card text-white bg-danger mb-3">
        <div class="card-body">
          <h6 class="card-title">Expense</h6>
          <h4>{{ expense | round(2) }}</h4>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card text-dark bg-light mb-3">
        <div class="card-body">
          <h6 class="card-title">Balance</h6>
          <h4>{{ balance | round(2) }}</h4>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12 col-lg-6 mb-4">
      <div class="card">
        <div class="card-header">Expenses by Category</div>
        <div class="card-body">
          <canvas id="pieChart" width="400" height="300"></canvas>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6 mb-4">
      <div class="card">
        <div class="card-header">Monthly Net (last 12 months)</div>
        <div class="card-body">
          <canvas id="barChart" width="400" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const expenseData = {{ expense_by_cat | safe }};
    const monthlyData = {{ monthly | safe }};

    // Pie chart
    const pieLabels = expenseData.map(e => e.category);
    const pieValues = expenseData.map(e => e.total);
    const ctxPie = document.getElementById('pieChart').getContext('2d');
    new Chart(ctxPie, {
      type: 'pie',
      data: {
        labels: pieLabels,
        datasets: [{
          data: pieValues,
          backgroundColor: pieLabels.map((_, i) => `hsl(${(i*60)%360} 70% 50%)`)
        }]
      }
    });

    // Bar / line chart for monthly net
    const months = monthlyData.map(m => m.month);
    const nets = monthlyData.map(m => parseFloat(m.net.toFixed(2)));
    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: months,
        datasets: [{
          label: 'Net',
          data: nets,
          backgroundColor: nets.map(n => n < 0 ? 'rgba(220,53,69,0.7)' : 'rgba(40,167,69,0.7)'),
          borderColor: nets.map(n => n < 0 ? 'rgba(220,53,69,1)' : 'rgba(40,167,69,1)'),
          borderWidth: 1
        }]
      },
      options: {
        scales: { y: { beginAtZero: true } }
      }
    });
  </script>
{% endblock %}
